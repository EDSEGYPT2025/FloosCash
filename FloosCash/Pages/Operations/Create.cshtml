@page
@model FloosCash.Pages.Operations.CreateModel
@{
    ViewData["Title"] = "تسجيل عملية جديدة";
}

<div class="row justify-content-center">
    <div class="col-12 col-lg-8">

        <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap shadow-sm" role="alert">
            <div class="d-flex mb-2 mb-md-0">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                </div>
                <div class="fs-4">
                    الوردية الحالية: <strong>@Model.ActiveShift?.EmployeeName</strong>
                </div>
            </div>
            <div class="fs-3 fw-bold bg-white text-dark px-3 py-1 rounded border border-info">
                نقدية الدرج المتاحة: <span class="text-primary fs-2">@Model.ExpectedDrawerCash.ToString("N0") ج.م</span>
            </div>
        </div>
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger shadow-sm">
                <h4 class="alert-title fw-bold mb-2">تنبيه: لا يمكن حفظ العملية!</h4>
                @Html.ValidationSummary(false, "", new { @class = "mb-0 fs-4 fw-bold" })
            </div>
        }

        <form method="post" class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-12 mb-3">
                        <label class="form-label fw-bold fs-3 mb-3">حدد نوع العملية:</label>
                        <div class="form-selectgroup form-selectgroup-boxes d-flex flex-row">
                            <label class="form-selectgroup-item flex-fill">
                                <input type="radio" asp-for="Operation.OperationType" value="إيداع" class="form-selectgroup-input" checked>
                                <div class="form-selectgroup-label d-flex align-items-center p-3">
                                    <div class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </div>
                                    <div>
                                        <span class="text-success fw-bold fs-2 d-block">إيداع (Deposit)</span>
                                        <span class="text-muted fs-5">استلام كاش ⬅️ تحويل رصيد للعميل</span>
                                    </div>
                                </div>
                            </label>

                            <label class="form-selectgroup-item flex-fill ms-2">
                                <input type="radio" asp-for="Operation.OperationType" value="سحب" class="form-selectgroup-input">
                                <div class="form-selectgroup-label d-flex align-items-center p-3">
                                    <div class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </div>
                                    <div>
                                        <span class="text-danger fw-bold fs-2 d-block">سحب (Withdrawal)</span>
                                        <span class="text-muted fs-5">استلام رصيد ⬅️ تسليم كاش للعميل</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="col-md-12 mb-2">
                        <label class="form-label required fs-4 d-flex align-items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" /><path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" /></svg>
                            المحفظة المستخدمة
                        </label>

                        <select asp-for="Operation.WalletId" asp-items="Model.WalletsList" id="wallet-select" class="form-select" required>
                            <option value="">-- ابحث بالاسم أو اختر المحفظة --</option>
                        </select>

                        <div id="wallet-info-card" class="card bg-blue-lt border-blue mt-3 d-none">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-12 mb-3 border-bottom pb-2">
                                        <span class="text-muted fw-bold d-block mb-1">الرصيد الفعلي المتاح في المحفظة:</span>
                                        <div id="info-balance" class="fs-2 fw-bolder text-primary">0 ج.م</div>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted fw-bold d-block mb-1">باقي ليمت <span id="info-type-lbl">...</span> (اليوم):</span>
                                        <div id="info-daily" class="fs-3 fw-bold">0 ج.م</div>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted fw-bold d-block mb-1">باقي ليمت <span id="info-type-lbl-2">...</span> (الشهر):</span>
                                        <div id="info-monthly" class="fs-3 fw-bold">0 ج.م</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <span asp-validation-for="Operation.WalletId" class="text-danger d-block mt-1 fw-bold fs-5"></span>
                    </div>

                    <div class="col-md-6 mt-4">
                        <label class="form-label required fs-4">المبلغ (ج.م)</label>
                        <div class="input-group input-group-flat">
                            <input asp-for="Operation.Amount" type="number" step="0.01" min="1" class="form-control form-control-lg text-end fs-2 fw-bold text-primary" placeholder="0.00" required />
                        </div>
                        <div id="amount-warning" class="text-danger fw-bold fs-5 mt-2 d-none"></div>
                    </div>

                    <div class="col-md-6 mt-4">
                        <label class="form-label fs-4">العمولة المحصلة (ج.م)</label>
                        <input asp-for="Operation.Commission" type="number" step="0.01" class="form-control form-control-lg" placeholder="0.00" />
                        <span class="form-hint">عمولة المكتب أو المحل عن هذه العملية</span>
                    </div>

                    <div class="col-12 mt-3">
                        <label class="form-label">رقم هاتف العميل / ملاحظات (اختياري)</label>
                        <input asp-for="Operation.Notes" class="form-control" placeholder="مثال: 01012345678" />
                    </div>

                </div>
            </div>

            <div class="card-footer bg-light text-end">
                <button type="submit" id="btn-submit" class="btn btn-primary btn-lg w-100 w-md-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M5 12l5 5l10 -10" /></svg>
                    تنفيذ العملية وحفظها
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        .swal2-popup, .swal2-title, .swal2-html-container, .swal2-confirm {
            font-family: 'Cairo', sans-serif !important;
            direction: rtl !important;
        }

        .ts-control {
            font-size: 1.25rem !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            border-radius: 8px !important;
        }

        .ts-dropdown {
            font-size: 1.25rem !important;
            border-radius: 8px !important;
        }

            /* تصميم المحافظ المعطلة في القائمة */
            .ts-dropdown .option.disabled {
                opacity: 0.5;
                background-color: #f8f9fa;
                text-decoration: line-through;
                color: #dc3545 !important;
            }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const walletsData = @Html.Raw(Model.WalletsJson ?? "[]");
            const drawerCash = @Model.ExpectedDrawerCash; // نقدية الدرج المحسوبة من السيرفر

            const amountInput = document.querySelector('input[name="Operation.Amount"]');
            const commissionInput = document.querySelector('input[name="Operation.Commission"]');
            const typeRadios = document.querySelectorAll('input[name="Operation.OperationType"]');
            const walletSelect = document.getElementById('wallet-select');

            const infoCard = document.getElementById('wallet-info-card');
            const infoBalance = document.getElementById('info-balance');
            const infoDaily = document.getElementById('info-daily');
            const infoMonthly = document.getElementById('info-monthly');
            const infoTypeLbl1 = document.getElementById('info-type-lbl');
            const infoTypeLbl2 = document.getElementById('info-type-lbl-2');

            const warningDiv = document.getElementById('amount-warning');

            let tsInstance = null; // متغير لحفظ نسخة القائمة المنسدلة الذكية

            // --- دالة القائمة الذكية (تعطيل/تفعيل المحافظ) ---
            function smartFilterDropdown() {
                if (!tsInstance) return;

                const amount = parseFloat(amountInput.value) || 0;
                const selectedType = document.querySelector('input[name="Operation.OperationType"]:checked').value;
                let currentSelectedId = parseInt(tsInstance.getValue());
                let isCurrentValid = true;

                walletsData.forEach(w => {
                    let isEligible = true;
                    if (amount > 0) {
                        if (selectedType === 'إيداع') {
                            if (amount > w.remainingDailyDeposit) isEligible = false;
                        } else { // سحب
                            if (amount > w.currentBalance || amount > w.remainingDailyWithdrawal) isEligible = false;
                        }
                    }

                    if (isEligible) {
                        tsInstance.enableOption(w.id);
                    } else {
                        tsInstance.disableOption(w.id);
                        if (currentSelectedId === w.id) isCurrentValid = false;
                    }
                });

                // إذا كانت المحفظة المحددة حالياً لم تعد تصلح للمبلغ الجديد، قم بإلغاء تحديدها فوراً
                if (!isCurrentValid && amount > 0) {
                    tsInstance.clear();
                    warningDiv.innerHTML = `⛔ المحفظة السابقة لا تكفي لهذا المبلغ. <strong>تم إلغاء التحديد، يرجى اختيار محفظة أخرى.</strong>`;
                    warningDiv.classList.remove('d-none');
                }
            }

            // تحديث كارت المعلومات
            function updateWalletInfo() {
                const walletId = parseInt(walletSelect.value);
                const selectedType = document.querySelector('input[name="Operation.OperationType"]:checked').value;

                if (!walletId) {
                    infoCard.classList.add('d-none');
                    return;
                }

                const wallet = walletsData.find(w => w.id === walletId);
                if (wallet) {
                    infoCard.classList.remove('d-none');
                    infoBalance.innerText = wallet.currentBalance.toLocaleString() + ' ج.م';
                    infoTypeLbl1.innerText = selectedType;
                    infoTypeLbl2.innerText = selectedType;

                    if (selectedType === 'إيداع') {
                        infoDaily.innerText = wallet.remainingDailyDeposit.toLocaleString() + ' ج.م';
                        infoDaily.className = 'fs-3 fw-bold text-success';
                        infoMonthly.innerText = wallet.remainingMonthlyDeposit.toLocaleString() + ' ج.م';
                        infoMonthly.className = 'fs-3 fw-bold text-success';
                    } else {
                        infoDaily.innerText = wallet.remainingDailyWithdrawal.toLocaleString() + ' ج.م';
                        infoDaily.className = 'fs-3 fw-bold text-danger';
                        infoMonthly.innerText = wallet.remainingMonthlyWithdrawal.toLocaleString() + ' ج.م';
                        infoMonthly.className = 'fs-3 fw-bold text-danger';
                    }
                }
            }

            // فحص الرصيد وإظهار تحذير لحظي
            function checkLimits() {
                const amount = parseFloat(amountInput.value) || 0;
                const selectedType = document.querySelector('input[name="Operation.OperationType"]:checked').value;
                const walletId = parseInt(walletSelect.value);

                let warningMsg = '';

                // إذا كان إيداع: الرصيد الفعلي للمحفظة هو العائق
                if (selectedType === 'إيداع' && walletId) {
                    const wallet = walletsData.find(w => w.id === walletId);
                    if (wallet && amount > wallet.currentBalance) {
                        warningMsg = `⛔ لا يمكن إتمام الإيداع، المبلغ أكبر من الرصيد المتوفر بالمحفظة (${wallet.currentBalance.toLocaleString()} ج).`;
                    }
                }
                // إذا كان سحب: رصيد الدرج الفعلي هو العائق
                else if (selectedType === 'سحب') {
                    if (amount > drawerCash) {
                        warningMsg = `⛔ لا يمكن إتمام السحب، النقدية المتاحة في الدرج (${drawerCash.toLocaleString()} ج) لا تكفي.`;
                    }
                }

                if (warningMsg) {
                    warningDiv.innerHTML = warningMsg;
                    warningDiv.classList.remove('d-none');
                } else if(tsInstance && tsInstance.getValue()) {
                    warningDiv.classList.add('d-none');
                }
            }

            // حساب العمولة التلقائي
            function calculateCommission() {
                const amount = parseFloat(amountInput.value) || 0;
                const walletId = parseInt(walletSelect.value);
                const selectedType = document.querySelector('input[name="Operation.OperationType"]:checked').value;

                if (!walletId || amount <= 0) return;

                const wallet = walletsData.find(w => w.id === walletId);
                if (wallet) {
                    let rate = selectedType === 'إيداع' ? wallet.depositRate : wallet.withdrawalRate;
                    let commission = amount * (rate / 100);
                    commissionInput.value = commission.toFixed(2);
                }
            }

            // تهيئة القائمة الذكية TomSelect
            if (document.getElementById('wallet-select')) {
                tsInstance = new TomSelect("#wallet-select", {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "-- اكتب للبحث عن المحفظة المتاحة --",
                    render: {
                        no_results: function(data, escape) {
                            return '<div class="no-results p-2 text-danger fw-bold">لا توجد محفظة بهذا الاسم</div>';
                        }
                    }
                });

                tsInstance.on('change', function() {
                    updateWalletInfo();
                    calculateCommission();
                    checkLimits();
                });
            }

            amountInput.addEventListener('input', function() {
                smartFilterDropdown(); // تشغيل الفلتر الذكي
                calculateCommission();
                checkLimits();
            });

            typeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    smartFilterDropdown(); // تشغيل الفلتر الذكي
                    updateWalletInfo();
                    calculateCommission();
                    checkLimits();
                });
            });

            @if (TempData["SuccessMessage"] != null)
            {
                        <text>
                        Swal.fire({
                            icon: 'success',
                            title: 'تمت العملية بنجاح',
                            text: '@Html.Raw(TempData["SuccessMessage"])',
                            confirmButtonText: 'متابعة العمل',
                            confirmButtonColor: '#2fb344',
                            background: '#ffffff',
                            color: '#1e293b',
                            backdrop: `rgba(0, 0, 0, 0.4)`,
                            allowOutsideClick: false,
                            customClass: {
                                title: 'fs-2 fw-bold',
                                popup: 'rounded-4 shadow-lg border-0',
                                confirmButton: 'btn btn-success btn-lg px-4'
                            }
                        });
                        </text>
            }
        });
    </script>
}