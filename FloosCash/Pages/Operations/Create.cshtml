@page
@model FloosCash.Pages.Operations.CreateModel
@{
    ViewData["Title"] = "تسجيل عملية جديدة";
}

<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <div class="alert alert-info" role="alert">
            <div class="d-flex">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                </div>
                <div>
                    يتم تسجيل هذه العملية على وردية الموظف: <strong>@Model.ActiveShift?.EmployeeName</strong>
                </div>
            </div>
        </div>

        <form method="post" class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-12 mb-3">
                        <label class="form-label fw-bold fs-3 mb-3">حدد نوع العملية:</label>
                        <div class="form-selectgroup form-selectgroup-boxes d-flex flex-row">
                            <label class="form-selectgroup-item flex-fill">
                                <input type="radio" asp-for="Operation.OperationType" value="إيداع" class="form-selectgroup-input" checked>
                                <div class="form-selectgroup-label d-flex align-items-center p-3">
                                    <div class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </div>
                                    <div>
                                        <span class="text-success fw-bold fs-2 d-block">إيداع (Deposit)</span>
                                        <span class="text-muted fs-5">استلام كاش وتحويل رصيد للعميل</span>
                                    </div>
                                </div>
                            </label>

                            <label class="form-selectgroup-item flex-fill ms-2">
                                <input type="radio" asp-for="Operation.OperationType" value="سحب" class="form-selectgroup-input">
                                <div class="form-selectgroup-label d-flex align-items-center p-3">
                                    <div class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </div>
                                    <div>
                                        <span class="text-danger fw-bold fs-2 d-block">سحب (Withdrawal)</span>
                                        <span class="text-muted fs-5">استلام رصيد وتسليم كاش للعميل</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="col-md-12 mb-4">
                        <label class="form-label required fs-4 d-flex align-items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M17 8v-3a1 1 0 0 0 -1 -1h-10a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1 -1 1h-12a2 2 0 0 1 -2 -2v-12" />
                                <path d="M20 12v4h-4a2 2 0 0 1 0 -4h4" />
                            </svg>
                            المحفظة المستخدمة
                        </label>

                        <select asp-for="Operation.WalletId" asp-items="Model.WalletsList" id="wallet-select" class="form-select" required>
                            <option value="">-- ابحث بالاسم أو اختر المحفظة --</option>
                        </select>

                        <span class="form-hint mt-2 text-muted fs-5">
                            اختر المحفظة التي سيتم سحب الرصيد منها أو الإيداع إليها.
                        </span>

                        <span asp-validation-for="Operation.WalletId" class="text-danger d-block mt-1 fw-bold fs-5"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required fs-4">المبلغ (ج.م)</label>
                        <div class="input-group input-group-flat">
                            <input asp-for="Operation.Amount" type="number" step="0.01" min="1" class="form-control form-control-lg text-end fs-2 fw-bold text-primary" placeholder="0.00" required />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fs-4">العمولة المحصلة (ج.م)</label>
                        <input asp-for="Operation.Commission" type="number" step="0.01" class="form-control form-control-lg" placeholder="0.00" />
                        <span class="form-hint">عمولة المكتب أو المحل عن هذه العملية</span>
                    </div>

                    <div class="col-12 mt-3">
                        <label class="form-label">رقم هاتف العميل / ملاحظات (اختياري)</label>
                        <input asp-for="Operation.Notes" class="form-control" placeholder="مثال: 01012345678" />
                    </div>

                </div>
            </div>

            <div class="card-footer bg-light text-end">
                <button type="submit" class="btn btn-primary btn-lg w-100 w-md-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M5 12l5 5l10 -10" /></svg>
                    تنفيذ العملية وحفظها
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <style>
        /* فرض خط Cairo والاتجاه على رسالة النجاح */
        .swal2-popup, .swal2-title, .swal2-html-container, .swal2-confirm {
            font-family: 'Cairo', sans-serif !important;
            direction: rtl !important;
        }

        /* تحسين شكل مربع البحث ليتناسب مع الخط الكبير الذي اخترناه */
        .ts-control {
            font-size: 1.25rem !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            border-radius: 8px !important;
        }

        .ts-dropdown {
            font-size: 1.25rem !important;
            border-radius: 8px !important;
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- 1. جلب بيانات العمولات من السيرفر ---
            const walletsData = @Html.Raw(Model.WalletsJson ?? "[]");

            const amountInput = document.querySelector('input[name="Operation.Amount"]');
            const commissionInput = document.querySelector('input[name="Operation.Commission"]');
            const typeRadios = document.querySelectorAll('input[name="Operation.OperationType"]');
            const walletSelect = document.getElementById('wallet-select');

            // دالة حساب العمولة
            function calculateCommission() {
                const amount = parseFloat(amountInput.value) || 0;
                const walletId = parseInt(walletSelect.value);
                const selectedType = document.querySelector('input[name="Operation.OperationType"]:checked').value;

                if (!walletId || amount <= 0) {
                    return; // لا تحسب شيء إذا لم يكتمل الإدخال
                }

                const wallet = walletsData.find(w => w.id === walletId);
                if (wallet) {
                    let rate = selectedType === 'إيداع' ? wallet.depositRate : wallet.withdrawalRate;
                    let commission = amount * (rate / 100);
                    commissionInput.value = commission.toFixed(2);
                }
            }

            // --- 2. تفعيل خاصية البحث (TomSelect) مع ربطها بالحساب التلقائي ---
            if (document.getElementById('wallet-select')) {
                let ts = new TomSelect("#wallet-select", {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "-- اكتب للبحث عن المحفظة --",
                    render: {
                        no_results: function(data, escape) {
                            return '<div class="no-results p-2 text-danger fw-bold">لا توجد محفظة بهذا الاسم</div>';
                        }
                    }
                });

                // تشغيل الحساب التلقائي عند تغيير المحفظة من القائمة
                ts.on('change', function() {
                    calculateCommission();
                });
            }

            // --- 3. تشغيل الحساب التلقائي عند كتابة المبلغ أو تغيير نوع العملية ---
            amountInput.addEventListener('input', calculateCommission);
            typeRadios.forEach(radio => radio.addEventListener('change', calculateCommission));

            // --- 4. كود رسالة النجاح ---
            @if (TempData["SuccessMessage"] != null)
            {
                    <text>
                    Swal.fire({
                        icon: 'success',
                        title: 'تمت العملية بنجاح',
                        text: '@Html.Raw(TempData["SuccessMessage"])',
                        confirmButtonText: 'متابعة العمل',
                        confirmButtonColor: '#2fb344',
                        background: '#ffffff',
                        color: '#1e293b',
                        backdrop: `rgba(0, 0, 0, 0.4)`,
                        allowOutsideClick: false,
                        customClass: {
                            title: 'fs-2 fw-bold',
                            popup: 'rounded-4 shadow-lg border-0',
                            confirmButton: 'btn btn-success btn-lg px-4'
                        }
                    });
                    </text>
            }
        });
    </script>
}